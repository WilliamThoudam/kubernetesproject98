!function i(n,a,o){function h(e,t){if(!a[e]){if(!n[e]){var s="function"==typeof require&&require;if(!t&&s)return s(e,!0);if(d)return d(e,!0);throw(s=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",s}s=a[e]={exports:{}},n[e][0].call(s.exports,function(t){return h(n[e][1][t]||t)},s,s.exports,i,n,a,o)}return a[e].exports}for(var d="function"==typeof require&&require,t=0;t<o.length;t++)h(o[t]);return h}({1:[function(t,e,s){"use strict";function i(){this.create()}var n,a,o,h,d;n=jQuery,a=_,o=peepso,window.PsChatInput=(h=n,a=a,(d=o).npm.objectAssign(i.prototype,d.npm.EventEmitter.prototype,{template:peepsochatdata.windowInputTemplate,create:function(){this.$el=h(this.template),this.$textarea=this.$el.find("textarea"),this.$addons=this.$el.find(".ps-js-addons"),this.$textarea.on("keydown",h.proxy(this.onKeyDown,this)),this.$textarea.on("input",h.proxy(this.onInput,this)),this.$textarea.on("click",h.proxy(this.onClick,this)),this.$textarea.on("focus",h.proxy(this.onFocus,this)),this.$textarea.on("blur",h.proxy(this.onBlur,this)),window.peepsophotosdata&&(this.$upload=this.$addons.find(".ps-js-photo-trigger"),this.$file=this.$el.find("input.ps-js-photo-file"),this.$upload.on("click",h.proxy(this.onUploadPhoto,this)),this.uploadPhotoInit())},focus:function(){this.$textarea.focus()},uploadPhotoInit:function(){var e,t=h(document),s="ps-chat-drop-intercept";t.data(s)||(t.data(s,1),t.bind("drop dragover",function(t){h(t.target).closest(".ps-chat-window").length&&t.preventDefault()})),this.$file.psFileupload({formData:{user_id:peepsodata.currentuserid},singleFileUploads:!1,sequentialUploads:!1,replaceFileInput:!1,pasteZone:null,dropZone:this.$el,dataType:"json",url:peepsodata.ajaxurl_legacy+"photosajax.upload_photo",add:h.proxy(function(t,e){this.validatePhoto(e)},this),done:h.proxy(function(t,e){e=e.result;e.success&&this.emit("submit","",{type:"photo","files[]":e.data.files})},this)}),e=setInterval(h.proxy(function(){var t=this.$el.parent();t&&(clearInterval(e),this.$file.psFileupload("option","dropZone",t.add(t.prev())))},this),1e3)},uploadPhoto:function(){this.$file.trigger("click")},validatePhoto:function(e){for(var t,s=0,i=0;i<e.files.length;i++){if(t=e.files[i],!/\.(gif|jpg|jpeg|tiff|png|jfif)$/i.test(t.name))return psmessage.show("",h("#photo-supported-format").text()).fade_out(psmessage.fade_time),!1;s+=parseInt(t.size)}var n={size:s,filesize:s,photos:e.files.length},a=(new Date).getTime()+Math.floor(1e3*Math.random());this.emit("photos_added",e.files.length,a);var o=this;d.postJson("photosajax.validate_photo_upload",n,function(t){t.success?e.submit():(o.emit("photos_cancel",a),psmessage.show("",t.errors[0]).fade_out(psmessage.fade_time))})},onKeyDown:function(t){13!==t.keyCode||t.shiftKey||(t.preventDefault(),t.stopPropagation(),this.emit("submit",h.trim(t.target.value)),this.$textarea.val(""),this.autosize())},onInput:function(t){this.autosize(),this.emit("change",t.target.value)},onClick:function(t){this.emit("click",t)},onFocus:function(t){this.emit("focus",t)},onBlur:function(t){this.emit("blur",t)},onUploadPhoto:function(){this.uploadPhoto()},autosize:a.debounce(function(){this.$textarea[0].style.height="",this.$textarea[0].style.height=Math.min(+this.$textarea[0].scrollHeight,100)+"px"},1)}),i)},{}],2:[function(t,e,o){(function(a){(function(){"use strict";Object.defineProperty(o,"__esModule",{value:!0}),o.default=i;var d=t("undefined"!=typeof window?window.jQuery:void 0!==a?a.jQuery:null),s=t("undefined"!=typeof window?window._:void 0!==a?a._:null),n=t("undefined"!=typeof window?window.peepso:void 0!==a?a.peepso:null);function t(t){return t&&t.__esModule?t:{default:t}}var e="ps-chat-sidebar-open";function i(){this.ids=[],this.create()}n.default.npm.objectAssign(i.prototype,n.default.npm.EventEmitter.prototype,{template:peepsochatdata.sidebarTemplate,itemTemplate:peepsochatdata.sidebarItemTemplate,translations:peepsochatdata.translations,create:function(){this.$el=(0,d.default)(this.template).hide(),this.$items=this.$el.find(".ps-chat-sidebar-items"),this.$notif=this.$el.find(".ps-chat-sidebar-label .ps-chat-sidebar-notif"),this.$label=this.$el.find(".ps-chat-sidebar-label").find("span"),this.visible=!1,this.$el.on("click",d.default.proxy(this.onToggle,this)),this.$el.on("click",".ps-chat-sidebar-item",d.default.proxy(this.onSelect,this)),this.$el.on("click",".ps-chat-close",d.default.proxy(this.onRemove,this))},isExpanded:function(){return this.$el.hasClass(e)},expand:function(){this.$el.addClass(e),this.emit("expand")},collapse:function(){this.$el.removeClass(e),this.emit("collapse")},toggle:function(){this.isExpanded()?this.collapse():this.expand()},reset:function(t,e){t=t||[],this.remove(s.default.difference(this.ids,t)),this.add(t),this.updateNotification(e)},add:function(t,e){var s,i,n,a;if(t&&t.length){for(a=0;a<t.length;a++)i=+t[a],-1===(n=this.ids.indexOf(i))&&((s=(0,d.default)(this.itemTemplate.replace(/\{id\}/g,i))).appendTo(this.$items),this.ids.push(i),this.update(i,s));for(a=0;a<t.length;a++)i=+t[a],a!==(n=this.ids.indexOf(i))&&(s=this.$items.children("[data-id="+i+"]"),this.ids.splice(n,1),this.ids.splice(a,0,i),0===a?s.prependTo(this.$items):s.insertBefore(this.$items.children().eq(a)));this.ids.length&&!this.visible&&(this.$el.show(),this.visible=!0),e&&this.emit("add",t),this.updateCounter()}},remove:function(t,e){var s,i,n;if(t&&t.length){for(n=0;n<t.length;n++)s=+t[n],0<=(i=this.ids.indexOf(s))&&(this.$items.children("[data-id="+s+"]").remove(),this.ids.splice(i,1));!this.ids.length&&this.visible&&(this.$el.hide(),this.visible=!1),e&&this.emit("remove",t),this.updateCounter()}},removeFirst:function(){if(this.ids.length){var t=this.ids[0];return this.remove([t]),t}},select:function(t){this.emit("select",+t)},update:function(o,t){var s=this;if(this.captions=this.captions||{},(t=t||this.$items.children("[data-id="+o+"]")).length){var e,i=t.find(".ps-js-caption"),h=this.captions[o];if(h)return i.find("img").attr("src",h.avatar),void i.find("span").html(h.name);i.data("deferCaption")||(i.data("deferCaption",1),e=function(){var t=n.default.disableAuth().disableError(),e={msg_id:o,chat:1,get_participants:1,get_messages:0};s.fetchQueue=s.fetchQueue||[],s.fetchQueueCounter=s.fetchQueueCounter||0,s.fetchQueueExec=s.fetchQueueExec||function(){var t,e,s,i,n,a=this;5<=this.fetchQueueCounter||!this.fetchQueue.length||(this.fetchQueueCounter++,e=(t=this.fetchQueue.shift()).transport,s=t.action,i=t.params,n=t.$caption,e.postJson(s,i,function(t){!t.success||(t=t.data.users)&&t.length&&(a.captions[o]=h={avatar:1===t.length?t[0].avatar:"",name:a.formatParticipants(t)},h.name=(0,d.default)("<span/>").html(h.name).text(),n.find("a").attr("aria-label",h.name),n.find("img").attr("src",h.avatar),n.find("span").html(h.name)),a.fetchQueueCounter--,a.fetchQueueExec()}))}.bind(s),s.fetchQueue.push({transport:t,action:"messagesajax.get_messages_in_conversation",params:e,$caption:i}),setTimeout(function(){return s.fetchQueueExec()},500)},this.isExpanded()?e():this.once("expand",function(){e()}))}},updateCounter:s.default.debounce(function(){this.counter||(this.counter=0),this.ids.length!==this.counter&&(this.counter=this.ids.length,this.$label.html(this.counter))},400),updateNotification:s.default.debounce(function(t){var e,s,i=0,n=!1;for(s in this.notifState||(this.notifState={}),t)-1!==this.ids.indexOf(+s)&&t[s]!==this.notifState[s]&&(n=!0,this.notifState[s]=t[s],e=this.$items.find(".ps-chat-sidebar-item-"+s).find(".ps-chat-sidebar-notif"),t[s]?(e.show(),i++):e.hide());n&&(i?this.$notif.html(i).show():this.$notif.hide())},400),formatParticipants:function(t){var e="&nbsp;";if(1===t.length)e=t[0].name_full;else if(1<t.length){e=[];for(var s=0,i=Math.min(2,t.length-1);s<i;s++)e.push(t[s].name_first);e=e.join(", "),e=2===t.length?this.translations.and.replace(/%s(.+)%s/,e+"$1"+t[t.length-1].name_first):3===t.length?this.translations.and_x_other.replace("%s",e).replace("%d",1):this.translations.and_x_others.replace("%s",e).replace("%d",t.length-2)}return e},onToggle:function(t){t.preventDefault(),t.stopPropagation(),this.toggle()},onSelect:function(t){t.preventDefault(),t.stopPropagation(),this.select((0,d.default)(t.currentTarget).data("id"))},onRemove:function(t){t.preventDefault(),t.stopPropagation(),this.remove([(0,d.default)(t.currentTarget).data("id")],!0),this.updateCounter()}})}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(t,e,s){"use strict";function i(t,e){e=e||{},this.id=t,this.oldestMessageId=!1,this.newestMessageId=!1,this.deletedMessageIds=[],this.caption=null,this.input=new PsChatInput,this.disabled=e.disabled||!1,this.muted=e.muted||!1,this.send_receipt=e.send_receipt||!1,this.receipt=e.receipt||!1,this.receipt_unread=e.receipt_unread||!1,this.create(),this.checkStatus()}var n,a,r,c;t("./chat-input"),n=jQuery,a=_,t=peepso,window.PsChatWindow=(r=n,a=a,(c=t).npm.objectAssign(i.prototype,c.npm.EventEmitter.prototype,{template:peepsochatdata.windowTemplate,messageTemplate:peepsochatdata.sendMessageTemplate,photosTemplate:peepsochatdata.sendPhotosTemplate,translations:peepsochatdata.translations,messageUrl:peepsochatdata.messageUrl,create:function(){var e=this;this.$el=r(this.template.replace(/\{id\}/g,this.id)),this.$header=this.$el.find(".ps-js-chat-window-header"),this.$status=this.$el.find(".ps-js-chat-window-status"),this.$notif=this.$header.find(".ps-js-chat-window-notif").hide(),this.$caption=this.$header.find(".ps-js-chat-window-caption"),this.$dropdown=this.$el.find(".ps-js-chat-window-dropdown"),this.$turnoff=this.$el.find(".ps-js-chat-window-turned-off"),this.$muted=this.$el.find(".ps-js-chat-window-muted"),this.$content=this.$el.find(".ps-js-chat-window-content"),this.$messages=this.$el.find(".ps-js-chat-window-messages"),this.$tmpchat=this.$el.find(".ps-js-chat-window-tmpchat"),this.$typing=this.$el.find(".ps-js-chat-window-typing"),this.$btnOption=this.$el.find(".ps-js-chat-options").hide(),this.$el.find(".ps-js-chat-window-input").append(this.input.$el),this.$el.on("click",".ps-js-chat-window-header",r.proxy(function(t){t.preventDefault(),t.stopPropagation(),this.toggle(!0)},this)),this.$content.on("click",".ps-js-conversation-content",function(t){t.stopPropagation()}),this.$content.on("click",r.proxy(function(t){this.focus()},this)),this.$el.on("click",".ps-js-chat-options",r.proxy(this.onOptions,this)),this.$el.on("click",".ps-js-chat-disable",r.proxy(this.onDisable,this)),this.$el.on("click",".ps-js-chat-mute",r.proxy(this.onMute,this)),this.$el.on("click",".ps-js-chat-fullscreen",r.proxy(this.onFullScreen,this)),this.$el.on("click",".ps-js-chat-blockuser",r.proxy(this.onBlockUser,this)),this.$el.on("click",".ps-js-chat-close",r.proxy(this.onClose,this)),this.$el.on("click",".ps-js-chat-checkmark",r.proxy(this.onToggleNotification,this)),this.expanded=!1,this.loadInitialMessages(),this.$caption.on("click","a",r.proxy(function(t){this.expanded?t.stopPropagation():t.preventDefault()},this)),this.updateDisabled(),this.updateMuted(),c.observer.addAction("msgso_send_message",r.proxy(this.send,this),10,3),c.observer.addAction("psmessages_conversation_mute",function(t){+t==+e.id&&(e.muted=!0,e.updateMuted())},10,1),c.observer.addAction("psmessages_conversation_unmute",function(t){+t==+e.id&&(e.muted=!1,e.updateMuted())},10,1)},loadInitialMessages:function(){this.loadNewerLock=!0,this.loadNewerCount||(this.loadNewerCount=0),this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:1},function(t){t.success&&(this.renderConversation(t.data),this.updateCheckmark(),this.scrollTo("bottom"),this.expanded||(this.scrollOnExpand=!0),this.input.on("submit",r.proxy(this.onInputSubmit,this)),this.input.on("click",r.proxy(this.onInputFocus,this)),this.input.on("focus",r.proxy(this.onInputFocus,this)),this.input.on("blur",r.proxy(this.onInputBlur,this)),this.input.on("change",r.proxy(this.onInputChange,this)),this.input.on("photos_added",r.proxy(this.onInputAddPhotos,this)),this.input.on("photos_cancel",r.proxy(this.onInputCancelAddPhotos,this)),this.loadNewerLock=!1,this.loadNewerQueue&&this.expanded&&(this.loadNewerQueue=!1,this.loadNewerMessages()),this.$content.bind("mousewheel",r.proxy(function(t,e){var s=r(t.currentTarget);0<e&&0===s.scrollTop()?(t.preventDefault(),this.loadOlderMessages()):e<0&&s.scrollTop()==s.get(0).scrollHeight-s.innerHeight()&&t.preventDefault()},this)))})},send:function(s,i,n){return r.Deferred(r.proxy(function(e){var t;(s=+s)===+this.id?(i=r.trim(i),n=n||{},i||n.type?(t=r.extend({},{content:i,id:peepsodata.currentuserid,uid:peepsodata.userid,type:"activity",parent_id:s},n),c.disableAuth().disableError().postJson("messagesajax.add_message",t,r.proxy(function(t){t.success&&(this.loadNewerMessages(),e.resolve())},this))):e.reject()):e.reject()},this))},loadNewerMessages:function(){this.loadNewerLock?this.loadNewerQueue=!0:(this.loadNewerLock=!0,this.loadNewerCount||(this.loadNewerCount=0),this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:++this.loadNewerCount%10==0?1:0,get_recently_deleted:1,direction:"new",from_id:this.newestMessageId},function(t){this.renderConversation(t.data,"append"),this.scrollTo("bottom"),this.loadNewerLock=!1,this.tmpNotEmpty&&(this.$tmpchat.empty(),this.tmpNotEmpty=!1),this.loadNewerQueue&&(this.loadNewerQueue=!1,this.loadNewerMessages())}))},loadOlderMessages:function(){this.loadOlderLock||(this.loadOlderLock=!0,this.loadMessages({msg_id:this.id,chat:1,get_messages:1,get_participants:0,get_recently_deleted:0,direction:"old",from_id:this.oldestMessageId},function(t){this.renderConversation(t.data,"prepend"),this.updateCheckmark(),this.scrollTo("top"),this.loadOlderLock=!1}))},loadMessages:function(t,e){this.loadMessagesXHR&&this.loadMessagesXHR.ret.abort(),this.loadMessagesXHR=c.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,r.proxy(function(t){r.proxy(e,this)(t),this.loadMessagesXHR=!1},this))},checkStatus:function(){var t={msg_id:this.id,chat:1,get_messages:0,get_participants:1,get_recently_deleted:0};clearInterval(this.checkStatusTimer),this.checkStatusTimer=setInterval(r.proxy(function(){this.checkStatusXHR&&this.checkStatusXHR.ret.abort(),this.checkStatusXHR=c.disableAuth().disableError().postJson("messagesajax.get_messages_in_conversation",t,r.proxy(function(t){this.renderConversation(t.data),this.checkStatusXHR=!1},this))},this),6e4)},renderConversation:function(t,e){var s;if(t.users&&t.users.length){this.caption=this.formatParticipants(t.users),this.$caption.html(this.caption||"&nbsp;");var i="";if(t.users.length)for(var n=0,a=Math.min(3,t.users.length);n<a;n++){var o=t.users[n],h=!!+o.online;i+='<div class="ps-avatar'.concat(h?" ps-avatar--online":"",'"><img src="').concat(o.avatar,'" /></div>')}this.$status.html(i),1<t.users.length&&this.$el.addClass("ps-chat__window--group");var d=this.$dropdown.find(".ps-js-chat-blockuser");1<t.users.length?d.hide():(d.show(),d.data("user-id",t.users[0].id))}if(t.ids&&t.ids.length&&t.html&&(d=c.observer.applyFilters("messages_render",r(t.html)),c.observer.doAction("peepso_external_link",d),"prepend"===e?(this.oldestMessageId=+t.ids[0],this.$messages.prepend(d)):"append"===e?(this.newestMessageId=+t.ids[t.ids.length-1],this.$messages.append(d)):(this.oldestMessageId=+t.ids[0],this.newestMessageId=+t.ids[t.ids.length-1],this.$messages.html(d))),t.recently_deleted&&t.recently_deleted.length)for(;t.recently_deleted.length;)s=+t.recently_deleted.shift(),-1===this.deletedMessageIds.indexOf(s)&&(this.deletedMessageIds.push(s),this.$messages.find(".ps-js-message-"+s).remove(),s===this.newestMessageId?this.newestMessageId=+this.$messages.find(".ps-js-message").last().data("id"):s===this.oldestMessageId&&(this.oldestMessageId=+this.$messages.find(".ps-js-message").first().data("id")));this.renderTyping(t.currently_typing)},renderTyping:function(t){this.$typing.html(t||""),clearTimeout(this.renderTypingTimer),this.renderTypingTimer=setTimeout(r.proxy(function(){this.$typing.html("")},this),5e3)},markAsRead:a.throttle(function(){c.disableAuth().disableError().postJson("messagesajax.mark_read_messages_in_conversation",{msg_id:this.id},function(){c.observer.applyFilters("pschat_mark_as_read")})},2e3),iAmTyping:a.throttle(function(){c.disableAuth().disableError().postJson("messagesajax.i_am_typing",{msg_id:this.id})},+peepsodata.notification_ajax_delay_min||5e3),focus:a.debounce(function(){this.input.focus()},100),update:function(t){var e=+(t=t||{}).unread||0;this.unread||(this.unread=0),this.unread!==e?(this.unread=e,this.expanded?this.loadNewerMessages():this.disabled||(this.unread?this.$notif.html(this.unread).show():this.$notif.hide())):this.last_activity!==t.last_activity&&(this.last_activity=t.last_activity,this.loadNewerMessages()),this.disabled!==t.disabled&&(this.disabled=t.disabled,this.updateDisabled()),this.muted!==t.muted&&(this.muted=t.muted,this.updateMuted()),this.send_receipt!==t.send_receipt&&(this.send_receipt=t.send_receipt,this.updateNotification()),this.receipt===t.receipt&&this.receipt_unread===t.receipt_unread||(this.receipt=t.receipt,this.receipt_unread=t.receipt_unread,this.receipt&&this.updateCheckmark())},toggle:function(t){this.expanded?this.collapse(t):this.expand(t)},expand:function(t){this.expanded||(this.$el.addClass("ps-chat__window--open"),this.$btnOption.show(),this.expanded=!0,this.focus(),0<this.unread&&(this.loadNewerMessages(),this.unread=0,this.$notif.hide()),this.scrollOnExpand&&(this.scrollTo("bottom"),this.scrollOnExpand=!1),t&&this.emit("expand",this.id))},collapse:function(t){this.expanded&&(this.$el.removeClass("ps-chat__window--open"),this.$btnOption.hide(),this.expanded=!1,t&&this.emit("collapse",this.id))},destroy:function(t){this.$el.remove(),t&&this.emit("destroy",this.id),this.removeAllListeners()},formatParticipants:function(t){var e;if(1===t.length)e='<a href="'+t[0].url+'">'+t[0].name_full+"</a>";else if(1<t.length){e=[];for(var s=0,i=Math.min(2,t.length-1);s<i;s++)e.push(t[s].name_first);e=e.join(", "),e=2===t.length?this.translations.and.replace(/%s(.+)%s/,e+"$1"+t[t.length-1].name_first):3===t.length?this.translations.and_x_other.replace("%s",e).replace("%d",1):this.translations.and_x_others.replace("%s",e).replace("%d",t.length-2),e='<a href="'+this.messageUrl.replace("{id}",this.id)+'">'+e+"</a>"}return e},scrollTo:function(t){this.$content[0].scrollTop="top"===t?0:this.$content[0].scrollHeight},toggleDisable:a.debounce(function(){var e={msg_id:this.id,disabled:this.disabled?0:1};this.$el.find(".ps-js-chat-disable img").show(),c.disableAuth().disableError().postJson("chatajax.set_chat_disabled",e,r.proxy(function(t){this.$el.find(".ps-js-chat-disable img").hide(),t.success&&(this.disabled=e.disabled,this.updateDisabled(),this.updateMuted(),this.toggleDropdown("hide"))},this))},400),updateDisabled:function(){var t;this.disabled?(t=this.translations.turn_on_chat,this.$el.removeClass("ps-chat__window--active"),this.$turnoff.show(),this.$notif.hide()):(t=this.translations.turn_off_chat,this.$turnoff.hide()),this.$el.find(".ps-js-chat-disable span").html(t)},toggleMute:a.debounce(function(){if(!this.muted)return this.toggleDropdown("hide"),void ps_messages.mute_conversation(this.id);var e={parent_id:this.id,mute:this.muted?0:1};this.$el.find(".ps-js-chat-mute img").show(),c.disableAuth().disableError().postJson("messagesajax.set_mute",e,r.proxy(function(t){this.$el.find(".ps-js-chat-mute img").hide(),t.success&&(c.observer.doAction("psmessages_conversation_"+(e.mute?"mute":"unmute"),e.parent_id),this.toggleDropdown("hide"))},this))},400),updateMuted:function(){var t=this.muted?this.translations.unmute_chat:this.translations.mute_chat;this.muted&&!this.disabled?(this.$el.removeClass("ps-chat__window--active"),this.$muted.show(),this.$notif.hide()):this.$muted.hide(),this.$el.find(".ps-js-chat-mute span").html(t)},toggleBlockUser:a.debounce(function(t){confirm(peepsomessagesdata.blockuser_confirm_text)&&(this.destroy(!0),ps_member.block_user(t))},400),toggleNotification:a.debounce(function(){var e={msg_id:this.id,read_notif:this.send_receipt?0:1};this.$el.find(".ps-js-chat-checkmark img").show(),c.disableAuth().disableError().postJson("chatajax.set_chat_read_notification",e,r.proxy(function(t){this.$el.find(".ps-js-chat-checkmark img").hide(),t.success&&(this.send_receipt=e.read_notif,this.updateNotification(),this.toggleDropdown("hide"))},this))},400),updateNotification:function(){this.$el.find(".ps-js-chat-checkmark").find("span").html(this.send_receipt?this.translations.hide_checkmark:this.translations.show_checkmark)},updateCheckmark:a.throttle(function(){var t;this.receipt&&(t=this.$messages.find(".gci-check-circle").addClass("read"),0<this.receipt_unread&&t.slice(0-this.receipt_unread).removeClass("read"))},1e3),toggleDropdown:function(t){"hide"===t?(this.$dropdown.hide(),this.$btnOption.removeClass("ps-chat__window-header-dropdown--open")):(this.$dropdown.show(),this.$btnOption.addClass("ps-chat__window-header-dropdown--open"))},onOptions:function(t){t.preventDefault(),t.stopPropagation(),this.$dropdown.is(":visible")?this.toggleDropdown("hide"):this.toggleDropdown("show")},onDisable:function(t){t.preventDefault(),t.stopPropagation(),this.toggleDisable()},onMute:function(t){t.preventDefault(),t.stopPropagation(),this.toggleMute()},onFullScreen:function(t){t.preventDefault(),t.stopPropagation(),window.location=this.messageUrl.replace("{id}",this.id)},onBlockUser:function(t){t.preventDefault(),t.stopPropagation();t=r(t.currentTarget).data();+t.userId&&this.toggleBlockUser(+t.userId)},onClose:function(t){t.preventDefault(),t.stopPropagation(),this.destroy(!0)},onToggleNotification:function(t){t.preventDefault(),t.stopPropagation(),this.toggleNotification()},onInputSubmit:function(t,e){e=e||{},((t=r.trim(t))||e.type)&&("activity"===(e=r.extend({},{content:t,id:peepsodata.currentuserid,uid:peepsodata.userid,type:"activity",parent_id:this.id},e)).type&&(this.tmpNotEmpty=!0,this.$tmpchat.append(this.messageTemplate.replace("{content}",t)),this.scrollTo("bottom")),c.disableAsync().disableAuth().disableError().postJson("messagesajax.add_message",e,r.proxy(function(t){t.success&&this.loadNewerMessages()},this)))},onInputFocus:function(t){t.stopPropagation(),this.markAsRead(),this.disabled||this.$el.addClass("ps-chat__window--active")},onInputBlur:function(t){t.stopPropagation(),this.$el.removeClass("ps-chat__window--active"),this.toggleDropdown("hide")},onInputChange:function(){this.iAmTyping()},onInputAddPhotos:function(t,e){for(var s=/\{item\}([\s\S]+)\{\/item\}/,i=this.photosTemplate.match(s)[1],n="",a=1;a<=t;a++)n+=i;this.tmpNotEmpty=!0,this.$tmpchat.append(this.photosTemplate.replace("{id}",e).replace(s,n)),this.scrollTo("bottom")},onInputCancelAddPhotos:function(t){this.$tmpchat.find(".my-message-photos-"+t).remove()}}),i)},{"./chat-input":1}],4:[function(t,e,s){"use strict";t("./chat-window");var i,g=(i=t("./chat-sidebar"))&&i.__esModule?i:{default:i};!function(f,w,m){window.PsChat=null,window.ps_chat={},window.ps_chat.open_chat=function(t){t=window.peepsochatdata.messageUrl.replace("{id}",t);f(document.body).hasClass("wp-admin")?window.open(t):window.location=t};/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent)||setTimeout(function(){function t(t){return t=t.split(/\r?\n/),t=s.map(t,function(t){return o.trim(t)}),t=s.filter(t,function(t){return t.length})}function e(){var t,e=window.location.pathname,s=+peepsodata.currentuserid,i=c,n=1===i?l:p;if(!s)return!(this.disabled=!0);if(this.disabled=1===i,n.length)for(t=0;t<n.length;t++)try{if(e.match(new RegExp("^"+n[t]+"(#|\\?|\\/|$)"))){this.disabled=!this.disabled;break}}catch(t){}if(this.disabled)return!1;this.state={},this.beforeDestroyState={},this.windows={},this.windowsOrder=[],this.windowsUpdate={},this.sidebar=new g.default,this.create()}var o,s,i,n,h,a,d,r,c,p,l;PsChat=(o=f,s=w,i=m,n=+peepsodata.sse,h=4,a=+peepsodata.notification_ajax_delay_min,d=+peepsodata.notification_ajax_delay,r=window.peepsomessagesdata||{},c=+r.chat_restriction_mode||0,p=t(r.chat_disable_on_pages||""),l=t(r.chat_enable_on_pages||""),i.npm.objectAssign(e.prototype,{template:peepsochatdata.containerTemplate,create:function(){this.$root=o(this.template),this.$wrapper=this.$root.children(".ps-js-chat"),this.$windows=this.$wrapper.children(".ps-js-chat-windows"),this.$wrapper.append(this.sidebar.$el),this.$root.appendTo(document.body),this.sidebar.on("select",o.proxy(this.onSidebarSelect,this)),this.sidebar.on("remove",o.proxy(this.onSidebarRemove,this)),o(window).off("resize.ps-js-chat").on("resize.ps-js-chat",o.proxy(this.onDocumentResize,this)),setTimeout(o.proxy(function(){n?this.fetchChatState():(this.onDocumentResize(),+peepsomessagesdata.get_chats_longpoll&&setInterval(o.proxy(function(){this.startLongPolling()},this),3e4))},this),3e3),i.observer.addAction("peepso_sse",o.proxy(function(t){"get_chats"===t.event&&this.fetchChatState()},this),10,1),i.observer.addAction("browser.inactive",o.proxy(function(){this.browserInactive=!0},this)),i.observer.addAction("browser.active",o.proxy(function(){this.browserInactive=!1,this.checkChatDelay=a,this.stopLongPolling(),this.startLongPolling()},this))},startLongPolling:function(){n||(this.stopLongPolling(),this.fetchChatState().done(o.proxy(function(){this.checkChatState()},this)))},stopLongPolling:function(){n||(clearTimeout(this.checkChatTimer),this.checkChatXHR&&this.checkChatXHR.abort(),this.fetchChatXHR&&this.fetchChatXHR.ret&&this.fetchChatXHR.ret.abort(),this.checkChatXHR=!1,this.fetchChatXHR=!1)},checkChatState:function(){this.checkChatXHR=o.post({url:peepsodata.ajaxurl,dataType:"json",data:{action:"peepso_should_get_chats",delay:this.checkChatDelay}}),this.checkChatXHR.always(o.proxy(function(t){var e=+(t=t||[])[1],t=+t[0];this.checkChatDelay=e||this.checkChatDelay,t?this.fetchChatState().always(o.proxy(function(){this.checkChatDelayed(e)},this)):this.checkChatDelayed(e)},this))},checkChatDelayed:function(t){t=t||a,this.browserInactive&&(t=d),this.checkChatTimer=setTimeout(o.proxy(this.checkChatState,this),t)},fetchChatState:function(){return this.fetchChatXHR?o.Deferred(o.proxy(function(t){t.resolveWith(this)},this)):(this.fetchChatXHR=i.disableAuth().disableError().postJson("chatajax.get_chats",{},o.proxy(function(t){var e,s;if(t.success){for(this.windowsOrder=[],s=0;s<t.data.chats.length;s++)e=t.data.chats[s],this.state[e.id]=this.state[e.id]||{},this.windowsOrder.push(+e.id),this.state[e.id].last_activity===e.last_activity&&this.state[e.id].muted===+e.muted&&this.state[e.id].disabled===+e.disabled&&this.state[e.id].send_receipt===+e.send_receipt&&this.state[e.id].receipt===+e.receipt&&this.state[e.id].receipt_unread===+e.receipt_unread||(!this.state[e.id].last_activity&&h<=s?this.windowsUpdate[e.id]=!1:this.windowsUpdate[e.id]=!0),o.extend(this.state[e.id],{state:e.state,unread:e.unread,last_activity:e.last_activity,disabled:+e.disabled,muted:+e.muted,send_receipt:+e.send_receipt,receipt:+e.receipt,receipt_unread:+e.receipt_unread});this.renderWindows()}this.fetchChatXHR=!1},this)),this.fetchChatXHR.ret)},getChatState:function(){for(var t,e,s=[],i=0;i<this.windowsOrder.length;i++)e=this.windowsOrder[i],t=this.state[e]||{},s.push({id:e,state:t.state||void 0,unread:t.unread||void 0,last_activity:t.last_activity||void 0});return s},setChatState:function(t,e){this.stopLongPolling(),this.state[t]=o.extend(this.state[t]||{},e),e=JSON.stringify(this.getChatState()),this.setChatStateXHR&&this.setChatStateXHR.ret.abort(),this.setChatStateXHR=i.disableAuth().disableError().postJson("chatajax.set_chats",{chats:e},o.proxy(function(){this.setChatStateXHR=!1,this.startLongPolling()},this))},renderWindows:function(){var t,e,s,i,n=this.windowsOrder.slice(h),a=this.windowsOrder.slice(0,h);for(t in this.windows)-1===a.indexOf(+this.windows[t].id)&&(this.windows[t].destroy(),delete this.windows[t]);for(i=0;i<a.length;i++)t=a[i],this.windows[t]||(this.windows[t]=this.createWindow(t),this.windows[t].$el.appendTo(this.$windows));for(i=0;i<a.length;i++)t=a[i],e=+this.state[t].state,s=this.windows[t].$el[0],i!==this.getWindowIndex(s)&&(0===i?s.prependTo(this.$windows):s.insertBefore(this.$windows.children().eq(i))),1==e?this.windows[t].expand():this.windows[t].collapse(),this.windowsUpdate[t]&&(this.windows[t].update(this.state[t]),this.windowsUpdate[t]=!1);this.sidebar.reset(n,this.windowsUpdate),this.sidebar.visible?this.$wrapper.addClass("ps-chat--more"):this.$wrapper.removeClass("ps-chat--more"),this.windowsOrder.length?this.backspacePrevented||(this.backspacePrevented=!0,o(document).on("keydown.ps-js-chat",function(t){8!==t.which||o(t.target).is("input, textarea")||t.preventDefault()})):this.backspacePrevented&&(this.backspacePrevented=!1,o(document).off("keydown.ps-js-chat"))},createWindow:function(t){t=new PsChatWindow(t,this.state[t]);return t.on("expand",o.proxy(this.onWindowExpand,this)),t.on("collapse",o.proxy(this.onWindowCollapse,this)),t.on("destroy",o.proxy(this.onWindowDestroy,this)),t},getWindowIndex:function(t){var e;if(o.contains(document.documentElement,t))for(e=0;t=t.previousSibling;e++);return e},openChat:function(t){var e;t=+t,-1===(e=this.windowsOrder.indexOf(t))?(this.windows[t]=this.createWindow(t),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windowsOrder.splice(h-1,0,t)):e<h?(this.windows[t].$el.show(),this.windows[t].expand()):(this.windows[t]||(this.windows[t]=this.createWindow(t)),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windowsOrder.splice(e,1),this.windowsOrder.splice(h-1,0,t)),this.windows[t].focus(),this.windows[t].markAsRead(),this.setChatState(t,{state:1}),this.beforeDestroyState[t]&&(this.state[t].disabled=this.beforeDestroyState[t].disabled,this.state[t].muted=this.beforeDestroyState[t].muted,this.state[t].send_receipt=this.beforeDestroyState[t].send_receipt),this.windowsUpdate[t]=!0,this.renderWindows()},closeChat:function(t){this.beforeDestroyState[t]=this.state[t],this.windows[t]&&this.windows[t].destroy(),delete this.windows[t],delete this.state[t],-1<(t=this.windowsOrder.indexOf(+t))&&this.windowsOrder.splice(t,1)},isDisabled:function(){return this.disabled},onWindowExpand:function(t){this.setChatState(t,{state:1})},onWindowCollapse:function(t){this.setChatState(t,{state:2})},onWindowDestroy:function(t){this.beforeDestroyState[t]=this.state[t],this.setChatState(t,{state:0}),delete this.windows[t],delete this.state[t];var e=this.windowsOrder.indexOf(+t);-1<e&&this.windowsOrder.splice(e,1),(t=this.sidebar.removeFirst())&&(this.windows[t]||(this.windows[t]=this.createWindow(t)),this.windows[t].$el.show(),this.windows[t].$el.appendTo(this.$windows),this.windows[t].expand())},onSidebarSelect:function(t){this.openChat(t)},onSidebarRemove:function(t){if(t&&t.length)for(var e=0;e<t.length;e++)this.setChatState(t[e],{state:0})},onDocumentResize:s.debounce(function(){var t=this.$windows.width(),e=Math.floor(t/246);this._prevWidth!==t&&(this._prevWidth=t,this.stopLongPolling(),1<=e?(h=e,this.renderWindows(),this.startLongPolling(),this.$root.show()):this.$root.hide())},500)}),e);var u=new PsChat;u.isDisabled()||(ps_chat.open_chat=function(t){u.openChat(t)})},100)}(jQuery||$,_,peepso)},{"./chat-sidebar":2,"./chat-window":3}],5:[function(t,e,s){"use strict";t("./chat")},{"./chat":4}]},{},[5]);